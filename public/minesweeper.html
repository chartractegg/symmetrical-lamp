<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Minesweeper â€” Retro Style</title>
<style>
  :root {
    --win-bg:#c0c0c0;
    --light:#ffffff;
    --mid:#dfdfdf;
    --shadow:#808080;
    --dark:#000000;
    --tile:#c0c0c0;
    --tile-face:#bdbdbd;
    --led-bg:#6b0000;
    --led-red:#ff1a1a;
    --flag-red:#c01818;
  }
  *{box-sizing:border-box; user-select:none}
  html,body{
    height:100%;
    margin:0;
    background:#2f2f2f;
    font:14px/1 system-ui,Segoe UI,Tahoma,Arial,sans-serif;
    overflow:auto; /* allow scroll for large boards */
    display:flex; justify-content:center; align-items:flex-start;
  }
  .window{
    background:var(--win-bg);
    padding:8px;
    border:2px solid var(--dark);
    margin:20px auto;
    box-shadow:
      inset -1px -1px 0 var(--shadow),
      inset 1px 1px 0 var(--light),
      inset -2px -2px 0 var(--dark),
      inset 2px 2px 0 var(--mid);
    display:inline-block; /* allow width to grow with board */
  }
  .titlebar{
    background:linear-gradient(#000080, #0000a8);
    color:#fff; padding:3px 6px; margin-bottom:6px;
    display:flex; justify-content:space-between; align-items:center;
    font-weight:700;
  }
  .frame{
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    padding:6px; background:var(--win-bg);
    display:inline-block; /* expand with board */
  }
  .panel{
    display:flex; justify-content:space-between; align-items:center; gap:8px;
    margin-bottom:6px; padding:6px;
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    background:var(--mid);
  }
  .display{
    width:56px; height:32px; display:grid; place-items:center;
    background:var(--led-bg); color:var(--led-red);
    font:700 22px/1 "Courier New",monospace;
    border:2px solid var(--dark);
    box-shadow: inset 0 1px 0 #3d0000, inset 0 -1px 0 #3d0000,
                inset 1px 0 0 #3d0000, inset -1px 0 0 #3d0000;
    letter-spacing:1px;
  }
  .btn{
    width:36px; height:36px; background:var(--win-bg); border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    display:grid; place-items:center; cursor:pointer;
  }
  .btn:active{
    box-shadow: inset -1px -1px 0 var(--light), inset 1px 1px 0 var(--dark);
  }
  .smiley{font-size:22px}
  .picker{display:flex; gap:6px; align-items:center}
  select{
    background:var(--win-bg);
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    padding:2px 4px;
  }
  .board{
    --rows:9; --cols:9;
    display:grid;
    grid-template-columns:repeat(var(--cols), 24px);
    gap:0;
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    background:var(--win-bg);
  }
  .cell{
    width:24px; height:24px;
    display:grid; place-items:center;
    background:var(--tile); cursor:pointer;
    border:2px solid var(--light);
    box-shadow: inset -1px -1px 0 var(--shadow), inset 1px 1px 0 var(--light);
    font-weight:700; font-size:16px;
  }
  .cell.revealed{
    background:var(--tile-face);
    border:1px solid var(--shadow);
    box-shadow:none; cursor:default;
  }
  .cell.mine.revealed{background:#ffcccc}
  .n1{color:#0000ff} .n2{color:#008000} .n3{color:#ff0000}
  .n4{color:#000080} .n5{color:#800000} .n6{color:#008080}
  .n7{color:#000000} .n8{color:#808080}
  .legend{margin-top:6px;color:#333}
</style>
</head>
<body>
  <div class="window">
    <div class="titlebar">
      <div>Minesweeper</div>
      <div>Â© Retro style</div>
    </div>

    <div class="frame">
      <div class="panel">
        <div class="display" id="mineCount">010</div>
        <div class="btn" id="resetBtn" title="New Game"><span class="smiley" id="smiley">ðŸ™‚</span></div>
        <div class="display" id="timer">000</div>
      </div>

      <div class="panel" style="justify-content:space-between">
        <div class="picker">
          <label>Difficulty:</label>
          <select id="difficulty">
            <option value="9x9x10">Beginner (9Ã—9, 10)</option>
            <option value="16x16x40">Intermediate (16Ã—16, 40)</option>
            <option value="16x30x99">Expert (16Ã—30, 99)</option>
          </select>
        </div>
        <div class="picker">
          <label>Right-click to Flag â€¢ Double-click number to Chord</label>
        </div>
      </div>

      <div id="board" class="board" aria-label="Minesweeper board"></div>
      <div class="legend" id="status"></div>
    </div>
  </div>

<script>
(() => {
  // ====== State ======
  const boardEl = document.getElementById('board');
  const mineCountEl = document.getElementById('mineCount');
  const timerEl = document.getElementById('timer');
  const resetBtn = document.getElementById('resetBtn');
  const smiley = document.getElementById('smiley');
  const diffSel = document.getElementById('difficulty');
  const statusEl = document.getElementById('status');

  let R=9, C=9, M=10;
  let grid = []; // cells: {r,c, mine, adj, revealed, flagged}
  let firstClick = true;
  let minesLeft = M;
  let timer = 0, timerHandle = null, running = false, alive = true, revealedCount = 0;

  // ====== Utils ======
  function pad3(n){ n=Math.max(0,Math.min(999,n)); return String(n).padStart(3,'0'); }
  function neighbors(r,c){
    const out=[];
    for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
      if(dr===0 && dc===0) continue;
      const nr=r+dr, nc=c+dc;
      if(nr>=0 && nr<R && nc>=0 && nc<C) out.push(grid[nr][nc]);
    }
    return out;
  }

  // ====== Setup ======
  function setDifficulty(spec){
    const [rs, cs, ms] = spec.split('x').map(Number);
    R=rs; C=cs; M=ms;
  }

  function newGrid(){
    boardEl.style.setProperty('--rows', R);
    boardEl.style.setProperty('--cols', C);
    boardEl.innerHTML = '';
    grid = [];
    for(let r=0;r<R;r++){
      const row=[];
      for(let c=0;c<C;c++){
        const cell = {
          r, c, mine:false, adj:0, revealed:false, flagged:false,
          el: document.createElement('div')
        };
        cell.el.className = 'cell';
        cell.el.setAttribute('data-r', r);
        cell.el.setAttribute('data-c', c);
        cell.el.addEventListener('mousedown', onMouseDown);
        cell.el.addEventListener('contextmenu', e => e.preventDefault());
        cell.el.addEventListener('dblclick', onChord);
        // --- Mobile long-press flagging support ---
let pressTimer;
cell.el.addEventListener('touchstart', e => {
  // prevent scrolling
  e.preventDefault();
  let isLong = false;
  pressTimer = setTimeout(() => {
    isLong = true;
    toggleFlag(cell);
    checkWin();
  }, 450); // long press threshold (~0.45s)

  const cancel = () => {
    clearTimeout(pressTimer);
    // If the press was short (tap), reveal
    if (!isLong && alive) {
      if (firstClick) {
        placeMines(cell.r, cell.c);
        firstClick = false;
        startTimer();
      }
      if (!cell.flagged && !cell.revealed) {
        reveal(cell);
        drawCell(cell);
        checkWin();
      }
    }
  };

  cell.el.addEventListener('touchend', cancel, {once: true});
  cell.el.addEventListener('touchmove', cancel, {once: true});
});

        
        boardEl.appendChild(cell.el);
        row.push(cell);
      }
      grid.push(row);
    }
  }

  function reset(){
    firstClick = true; running = false; alive = true; revealedCount = 0;
    clearInterval(timerHandle); timerHandle=null; timer=0; timerEl.textContent=pad3(0);
    minesLeft = M; mineCountEl.textContent = pad3(minesLeft);
    smiley.textContent = 'ðŸ™‚';
    statusEl.textContent = '';
    newGrid();
  }

  function startTimer(){
    if(running) return;
    running = true;
    timerHandle = setInterval(()=>{
      timer++; timerEl.textContent = pad3(timer);
      if(timer>=999){ clearInterval(timerHandle); timerHandle=null; running=false; }
    }, 1000);
  }

  // place mines avoiding first click cell & its neighbors
  function placeMines(safeR, safeC){
    const forbid = new Set([`${safeR},${safeC}`]);
    neighbors(safeR,safeC).forEach(n=>forbid.add(`${n.r},${n.c}`));
    let placed = 0;
    while(placed < M){
      const r=Math.floor(Math.random()*R), c=Math.floor(Math.random()*C);
      const key = `${r},${c}`;
      if(forbid.has(key) || grid[r][c].mine) continue;
      grid[r][c].mine = true; placed++;
    }
    // compute adjacencies
    for(let r=0;r<R;r++) for(let c=0;c<C;c++){
      if(grid[r][c].mine) continue;
      grid[r][c].adj = neighbors(r,c).reduce((n,cc)=>n+(cc.mine?1:0),0);
    }
  }

  // ====== Rendering ======
  function drawCell(cell){
    const el = cell.el;
    el.className = 'cell' + (cell.revealed ? ' revealed' : '');
    el.textContent = '';
    if(cell.revealed){
      if(cell.mine){
        el.textContent = 'ðŸ’£';
      }else if(cell.adj>0){
        el.classList.add('n'+cell.adj);
        el.textContent = cell.adj;
      }
    }else if(cell.flagged){
      el.textContent = 'âš‘';
      el.style.color = 'var(--flag-red)';
      el.style.fontSize = '16px';
    }else{
      el.style.color = '';
    }
  }

  function drawAll(){
    for(let r=0;r<R;r++) for(let c=0;c<C;c++) drawCell(grid[r][c]);
  }

  // ====== Game actions ======
  function reveal(cell){
    if(cell.revealed || cell.flagged || !alive) return;
    cell.revealed = true; revealedCount++;
    drawCell(cell);
    if(cell.mine){
      lose(cell);
      return;
    }
    if(cell.adj===0){
      neighbors(cell.r,cell.c).forEach(reveal);
    }
  }

  function toggleFlag(cell){
    if(cell.revealed || !alive) return;
    cell.flagged = !cell.flagged;
    minesLeft += cell.flagged ? -1 : 1;
    mineCountEl.textContent = pad3(minesLeft);
    drawCell(cell);
  }

  function checkWin(){
    // Win when all non-mines are revealed
    if(!alive) return;
    const needed = R*C - M;
    if(revealedCount >= needed){
      alive=false; running=false; clearInterval(timerHandle);
      smiley.textContent = 'ðŸ˜Ž';
      statusEl.textContent = 'You win!';
      // auto-flag remaining
      for(let r=0;r<R;r++) for(let c=0;c<C;c++){
        const cell=grid[r][c];
        if(cell.mine && !cell.flagged){ cell.flagged=true; drawCell(cell); }
      }
    }
  }

  function lose(hitCell){
    alive=false; running=false; clearInterval(timerHandle);
    smiley.textContent = 'ðŸ˜µ';
    statusEl.textContent = 'Boom! Game over.';
    // reveal all mines
    for(let r=0;r<R;r++) for(let c=0;c<C;c++){
      const cell = grid[r][c];
      if(cell.mine){ cell.revealed = true; }
      if(cell===hitCell){ cell.el.style.background = '#ff9ea3'; }
      drawCell(cell);
    }
  }

  // chord: if flagged count equals number, reveal neighbors
  function chord(cell){
    if(!cell.revealed || cell.adj===0) return;
    const adj = neighbors(cell.r,cell.c);
    const flagged = adj.filter(n=>n.flagged).length;
    if(flagged === cell.adj){
      adj.forEach(n=>{ if(!n.flagged && !n.revealed) reveal(n); });
    }
  }

  // ====== Events ======
  function onMouseDown(e){
    e.preventDefault();
    if(!alive) return;
    const r = +this.getAttribute('data-r');
    const c = +this.getAttribute('data-c');
    const cell = grid[r][c];

    // start timer on first action
    if(firstClick){
      placeMines(r,c);
      firstClick = false;
      startTimer();
    }

    if(e.button === 2){ // right
      toggleFlag(cell);
      checkWin();
      return;
    }
    if(e.button === 0){ // left
      if(cell.flagged) return;
      reveal(cell);
      drawCell(cell);
      checkWin();
    }
  }

  function onChord(e){
    e.preventDefault();
    if(!alive) return;
    const r = +this.getAttribute('data-r');
    const c = +this.getAttribute('data-c');
    const cell = grid[r][c];
    chord(cell);
    checkWin();
  }

  // ====== Wiring ======
  resetBtn.addEventListener('click', ()=>{ reset(); });
  diffSel.addEventListener('change', ()=>{
    setDifficulty(diffSel.value);
    reset();
  });

  // ====== Boot ======
  setDifficulty(diffSel.value);
  reset();
})();
</script>
  <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Blackjack â€” Symmetrical Lamp</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --win:#c0c0c0; --light:#ffffff; --mid:#dfdfdf; --shadow:#808080; --dark:#000000;
    --felt:#5a7751; --ink:#000; --red:#b00000;
  }
  *{box-sizing:border-box; user-select:none}
  html,body{height:100%}
  body{
    margin:0; background:#c0c0c0; color:var(--ink);
    font:14px/1 Tahoma, Verdana, Arial, sans-serif;
    display:flex; align-items:center; justify-content:center;
  }

  .window{
    background:var(--win); border:2px solid var(--dark);
    box-shadow: inset -1px -1px 0 var(--shadow), inset 1px 1px 0 var(--light),
                inset -2px -2px 0 var(--dark), inset 2px 2px 0 var(--mid);
    padding:8px; width:min(96vw, 940px);
  }
  .titlebar{
    background:linear-gradient(#000080,#0000a8); color:#fff;
    padding:3px 6px; margin-bottom:6px;
    display:flex; justify-content:space-between; align-items:center;
    font-weight:700;
  }
  .frame{
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    padding:8px; background:var(--mid);
  }

  .panel{
    display:flex; gap:8px; flex-wrap:wrap;
    align-items:center; justify-content:space-between;
    padding:6px; background:var(--mid);
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    margin-bottom:8px;
  }
  .badge{
    min-width:120px; text-align:center; font-weight:700;
    background:#6b0000; color:#ff1a1a;
    font-family:"Courier New", monospace; letter-spacing:1px;
    padding:4px 8px; border:2px solid var(--dark);
    box-shadow: inset 0 1px 0 #3d0000, inset 0 -1px 0 #3d0000,
                inset 1px 0 0 #3d0000, inset -1px 0 0 #3d0000;
  }
  .small{ font-size:12px; opacity:.85 }
  .label{font-weight:700; margin-right:4px}
  input[type=number]{
    width:90px; background:var(--win); border:2px solid var(--shadow); padding:2px 4px;
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    font:14px/1 Tahoma, Arial;
  }

  .table{ display:grid; grid-template-columns:1fr 230px; gap:8px }
  .felt{
    background:var(--felt); border-radius:8px; padding:10px;
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 #2f3f2f;
    min-height:380px;
  }

  .area{ margin-bottom:10px }
  .heading{
    font-weight:700; margin-bottom:4px;
    display:flex; align-items:center; gap:6px;
  }
  .tot{
    background:#000; color:#ff1a1a;
    font-family:"Courier New", monospace;
    padding:2px 6px; border:2px inset #333;
    min-width:24px; text-align:center;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap }
  .hand{
    background:rgba(255,255,255,0.08);
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    padding:6px; border-radius:4px; min-width:230px;
  }
  .hand.active{ outline:2px dotted #000 }
  .cards{ display:flex; gap:6px; flex-wrap:wrap }

  /* base cards (no animation by default) */
  .card{
    width:48px; height:64px;
    border:1px solid #999; border-radius:2px;
    background:#fff; display:grid; place-items:center;
    font-family:"Courier New", monospace; font-weight:700; color:#000;
  }
  .card.red{ color:var(--red); }
  .card.back{ background:#d9d9d9; border-style:double; }

  /* animated deal card */
  .card.deal{
    animation:dealIn 260ms ease-out both;
  }
  .card.deal[data-i]{
    animation-delay: calc(var(--i, 0) * 0.18s); /* more delay between sequence cards */
  }

  @keyframes dealIn{
    from{ transform:translate(-60px,-50px) rotate(-4deg); opacity:0; }
    to{ transform:translate(0,0) rotate(0deg); opacity:1; }
  }

  /* flip reveal for dealer hole */
  .flip-reveal{
    animation:flipReveal 320ms ease-out both;
    transform-origin:center;
  }
  @keyframes flipReveal{
    0%{ transform:scaleX(0); }
    100%{ transform:scaleX(1); }
  }

  .side{ display:grid; gap:8px }
  .group{
    background:var(--mid);
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    padding:8px;
  }
  .buttons{ display:flex; gap:8px; flex-wrap:wrap }
  button{
    background:var(--win); border:2px solid var(--shadow); padding:6px 12px; cursor:pointer;
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    font:14px/1 Tahoma, Arial;
  }
  button:active{ box-shadow: inset -1px -1px 0 var(--light), inset 1px 1px 0 var(--dark); }
  button:disabled{ color:#666; cursor:not-allowed }

  .morewrap{ position:relative }
  .moremenu{
    position:absolute; right:0; top:110%; min-width:180px; display:none; z-index:10;
    background:var(--win); border:2px solid var(--dark);
    box-shadow:4px 4px 0 rgba(0,0,0,.25),
      inset -1px -1px 0 var(--shadow),
      inset 1px 1px 0 var(--light);
  }
  .moremenu button{
    width:100%; text-align:left; padding:6px 10px;
    border:none; border-bottom:1px solid #aaa;
  }
  .moremenu button:last-child{ border-bottom:none }

  .msg{ margin-top:6px; font-weight:700 }

  @media (max-width:820px){
    .table{ grid-template-columns:1fr }
  }
</style>
</head>
<body>
<div class="window">
  <div class="titlebar">
    <div>Blackjack</div><div>Win98 Retro</div>
  </div>
  <div class="frame">
    <div class="panel">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <div class="badge">BANK $<span id="bank">1000</span></div>
        <div class="badge">BET $<span id="betDisp">10</span></div>
        <div class="badge">SHOE <span id="shoeLeft">0</span></div>
        <div class="small">3:2 blackjack â€¢ S17 â€¢ One seat (split supported)</div>
      </div>
      <div style="display:flex; gap:6px; align-items:center">
        <span class="label">Bet</span>
        <input id="bet" type="number" min="1" step="1" value="10">
      </div>
    </div>

    <div class="table">
      <div class="felt">
        <div class="area">
          <div class="heading">DEALER <span class="tot" id="dealerTot"></span></div>
          <div class="cards" id="dealerCards"></div>
        </div>
        <hr style="border:0; height:2px; background:#2f3f2f; margin:8px 0">
        <div class="area">
          <div class="heading">PLAYER</div>
          <div id="hands" class="row"></div>
          <div class="msg" id="msg"></div>
        </div>
      </div>

      <div class="side">
        <div class="group">
          <div class="buttons">
            <button id="deal">Deal</button>
            <button id="hit" disabled>Hit</button>
            <button id="stand" disabled>Stand</button>
            <div class="morewrap">
              <button id="more">â€¦</button>
              <div class="moremenu" id="moreMenu">
                <button id="double" disabled>Double</button>
                <button id="split" disabled>Split</button>
                <button id="surrender" disabled>Surrender</button>
              </div>
            </div>
          </div>
        </div>
        <div class="group">
          <button id="newShoe">New 6-Deck Shoe</button>
          <div class="small" style="margin-top:6px">Auto reshuffle at ~25% remaining.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);

  const bankEl = $("bank"), betDisp = $("betDisp"), betInput = $("bet"), shoeLeft = $("shoeLeft");
  const dealerCardsEl = $("dealerCards"), dealerTotEl = $("dealerTot");
  const handsEl = $("hands"), msgEl = $("msg");
  const dealBtn = $("deal"), hitBtn = $("hit"), standBtn = $("stand");
  const moreBtn = $("more"), moreMenu = $("moreMenu");
  const doubleBtn = $("double"), splitBtn = $("split"), surrenderBtn = $("surrender");
  const newShoeBtn = $("newShoe");

  const SUITS = ["â™ ","â™¥","â™¦","â™£"];
  const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  const DECKS = 6, CUT = 0.75;

  let shoe = [], discard = [];
  let bankroll = 1000, bet = 10;

  let dealer = [];
  let hands = [];
  let active = 0;
  let inRound = false;
  let firstAction = false;
  let holeDown = true;
  let justRevealedHole = false;
  let dealSeq = 0; // animation order index per round

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j = (Math.random()*(i+1))|0;
      [a[i],a[j]] = [a[j],a[i]];
    }
  }
  function freshShoe(){
    shoe = []; discard = [];
    for(let d=0; d<DECKS; d++){
      for(const s of SUITS){
        for(const r of RANKS){
          shoe.push({rank:r,suit:s});
        }
      }
    }
    shuffle(shoe);
    updateShoe();
    msg("New shoe ready.");
  }
  function updateShoe(){ shoeLeft.textContent = shoe.length; }
  function draw(){
    if(!shoe.length) freshShoe();
    const c = shoe.pop();
    updateShoe();
    return c;
  }
  function ensurePen(){
    if(shoe.length < 52*DECKS*(1-CUT)) freshShoe();
  }

  const isRed = s => (s==="â™¥"||s==="â™¦");
  function val(r){
    if(r==="A") return 11;
    if(["10","J","Q","K"].includes(r)) return 10;
    return parseInt(r,10);
  }
  function total(cards){
    let t=0, aces=0;
    for(const c of cards){ t += val(c.rank); if(c.rank==="A") aces++; }
    while(t>21 && aces>0){ t -= 10; aces--; }
    return t;
  }
  function visibleDealer(){
    if(!dealer.length) return "";
    return holeDown ? total([dealer[0]]) : total(dealer);
  }
  function sameValue(a,b){ return val(a.rank)===val(b.rank); }

  function cardEl(card){
    const el = document.createElement("div");
    let cls = "card";
    if(isRed(card.suit)) cls += " red";
    if(card._animateOnce) cls += " deal";
    el.className = cls;
    el.textContent = card.rank + card.suit;
    if(card._animateOnce && typeof card._order==="number"){
      const idx = Math.max(0, Math.min(card._order, 4));
      el.dataset.i = idx;
      el.style.setProperty("--i", idx);
    }
    return el;
  }
  function backEl(){
    const el = document.createElement("div");
    el.className = "card back";
    return el;
  }

  function renderDealer(){
    dealerCardsEl.innerHTML = "";
    dealer.forEach((c,i)=>{
      if(i===1 && holeDown){
        dealerCardsEl.appendChild(backEl());
      }else{
        const el = cardEl(c);
        if(!holeDown && i===1 && justRevealedHole){
          el.classList.add("flip-reveal");
        }
        dealerCardsEl.appendChild(el);
      }
    });
    dealerTotEl.textContent = visibleDealer();
  }

  function renderHands(){
    handsEl.innerHTML = "";
    hands.forEach((h,i)=>{
      const wrap = document.createElement("div");
      wrap.className = "hand" + ((inRound && i===active) ? " active" : "");
      const head = document.createElement("div");
      head.className = "heading";
      head.innerHTML = `HAND ${i+1} <span class="tot">${total(h.cards)}</span>`;
      const cardsDiv = document.createElement("div");
      cardsDiv.className = "cards";
      h.cards.forEach(c => cardsDiv.appendChild(cardEl(c)));
      wrap.appendChild(head);
      wrap.appendChild(cardsDiv);
      handsEl.appendChild(wrap);
    });
  }

  function setButtons(){
    if(!inRound){
      dealBtn.disabled = false;
      hitBtn.disabled = true;
      standBtn.disabled = true;
      doubleBtn.disabled = true;
      splitBtn.disabled = true;
      surrenderBtn.disabled = true;
    }else{
      dealBtn.disabled = true;
      const h = hands[active];
      hitBtn.disabled = false;
      standBtn.disabled = false;
      const canD = firstAction && bankroll >= h.bet;
      const canS = firstAction && h.cards.length===2 && bankroll>=h.bet && sameValue(h.cards[0],h.cards[1]);
      doubleBtn.disabled = !canD;
      splitBtn.disabled = !canS;
      surrenderBtn.disabled = !firstAction;
    }
  }

  function clearAnimationFlags(){
    hands.forEach(h=>h.cards.forEach(c=>{ if(c._animateOnce) c._animateOnce=false; }));
    dealer.forEach(c=>{ if(c._animateOnce) c._animateOnce=false; });
  }

  function renderHUD(){
    bankEl.textContent = bankroll;
    betDisp.textContent = bet;
    setButtons();
    justRevealedHole = false;
    clearAnimationFlags();
  }

  function renderAll(){
    renderDealer();
    renderHands();
    renderHUD();
  }
  function renderHandsOnly(){
    renderHands();
    renderHUD();
  }

  function msg(t){ msgEl.textContent = t || ""; }

  function currentHand(){ return hands[active]; }

  function startRound(){
    if(inRound) return;
    bet = Math.max(1, Math.floor(Number(betInput.value || 10)));
    if(bet > bankroll){
      msg("Bet exceeds bankroll.");
      return;
    }
    ensurePen();
    bankroll -= bet;
    dealer = [];
    hands = [{cards:[], bet, done:false}];
    active = 0;
    inRound = true;
    firstAction = true;
    holeDown = true;
    justRevealedHole = false;
    dealSeq = 0;
    msg("");

    // initial deal: P D P D
    let c;
    c = draw(); c._animateOnce=true; c._order = dealSeq++; hands[0].cards.push(c);
    c = draw(); c._animateOnce=true; c._order = dealSeq++; dealer.push(c);
    c = draw(); c._animateOnce=true; c._order = dealSeq++; hands[0].cards.push(c);
    c = draw(); c._animateOnce=true; c._order = dealSeq++; dealer.push(c);

    renderAll();

    const pTot = total(hands[0].cards);
    const dTot = total(dealer);
    const playerBJ = (pTot===21 && hands[0].cards.length===2);
    const dealerBJ = (dTot===21 && dealer.length===2);

    if(playerBJ || dealerBJ){
      resolveNaturals(playerBJ, dealerBJ);
    }
  }

  function resolveNaturals(playerBJ, dealerBJ){
    holeDown = false;
    justRevealedHole = true;

    let outcome = "";
    let net = 0;
    const b = hands[0].bet;

    if(playerBJ && dealerBJ){
      bankroll += b;
      outcome = "Push (both blackjack).";
    }else if(playerBJ){
      const pay = b*2.5;
      bankroll += pay;
      net = pay - b;
      outcome = "Blackjack!";
    }else if(dealerBJ){
      outcome = "Dealer blackjack.";
    }
    inRound = false;
    renderAll();
    if(net>0) msg(`${outcome} You win $${net.toFixed(0)}.`);
    else msg(outcome);
  }

  function nextStep(){
    let next = -1;
    for(let i=active+1;i<hands.length;i++){
      if(!hands[i].done){ next = i; break; }
    }
    if(next !== -1){
      active = next;
      firstAction = true;
      renderHandsOnly();
    }else{
      dealerPlay();
    }
  }

  function dealerPlay(){
    holeDown = false;
    justRevealedHole = true;
    renderAll();

    while(total(dealer) < 17){
      const c = draw();
      c._animateOnce = true;
      c._order = dealer.length;
      dealer.push(c);
      renderAll();
    }
    settleRound();
  }

  function settleRound(){
    const dTot = total(dealer);
    let net = 0;
    for(const h of hands){
      const pTot = total(h.cards);
      const playerBJ = (pTot===21 && h.cards.length===2);
      let result = "lose";

      if(pTot>21){
        result = "lose";
      }else if(dTot>21){
        result = "win";
      }else if(playerBJ && dealer.length===2 && dTot===21){
        result = "push";
      }else if(playerBJ){
        result = "blackjack";
      }else if(pTot>dTot){
        result = "win";
      }else if(pTot===dTot){
        result = "push";
      }else{
        result = "lose";
      }

      if(result==="blackjack"){
        const pay = h.bet*2.5;
        bankroll += pay;
        net += pay - h.bet;
      }else if(result==="win"){
        const pay = h.bet*2;
        bankroll += pay;
        net += h.bet;
      }else if(result==="push"){
        bankroll += h.bet;
      }
    }
    inRound = false;
    renderAll();
    if(net>0) msg(`You win $${net.toFixed(0)}.`);
    else if(net<0) msg("You lose.");
    else msg("Push.");
  }

  function doHit(){
    if(!inRound) return;
    const h = currentHand();
    const c = draw();
    c._animateOnce = true;
    c._order = h.cards.length;
    h.cards.push(c);
    firstAction = false;
    renderHandsOnly();
    if(total(h.cards)>21){
      h.done = true;
      nextStep();
    }
  }

  function doStand(){
    if(!inRound) return;
    const h = currentHand();
    h.done = true;
    firstAction = false;
    nextStep();
  }

  function doDouble(){
    if(!inRound) return;
    const h = currentHand();
    if(!firstAction || bankroll < h.bet) return;
    bankroll -= h.bet;
    h.bet *= 2;
    const c = draw();
    c._animateOnce = true;
    c._order = h.cards.length;
    h.cards.push(c);
    firstAction = false;
    renderHandsOnly();
    h.done = true;
    if(total(h.cards)>21){
      nextStep();
    }else{
      nextStep();
    }
  }

  function doSplit(){
    if(!inRound) return;
    const h = currentHand();
    if(!firstAction || h.cards.length!==2 || bankroll < h.bet) return;
    if(!sameValue(h.cards[0],h.cards[1])) return;

    bankroll -= h.bet;
    const c1 = h.cards[0];
    const c2 = h.cards[1];

    const newHands = [];
    for(let i=0;i<hands.length;i++){
      if(i===active){
        let c;
        c = draw(); c._animateOnce=true; c._order=0;
        newHands.push({cards:[c1, c], bet:h.bet, done:false});
        c = draw(); c._animateOnce=true; c._order=0;
        newHands.push({cards:[c2, c], bet:h.bet, done:false});
      }else{
        newHands.push(hands[i]);
      }
    }
    hands = newHands;
    active = active;
    firstAction = true;
    renderHandsOnly();
  }

  function doSurrender(){
    if(!inRound) return;
    const h = currentHand();
    if(!firstAction) return;
    bankroll += Math.floor(h.bet/2);
    h.done = true;
    const any = hands.some(x=>!x.done);
    if(!any){
      inRound=false;
      renderAll();
      msg("Surrender.");
    }else{
      nextStep();
    }
  }

  // Wire up
  dealBtn.addEventListener("click", startRound);
  hitBtn.addEventListener("click", doHit);
  standBtn.addEventListener("click", doStand);
  doubleBtn.addEventListener("click", doDouble);
  splitBtn.addEventListener("click", doSplit);
  surrenderBtn.addEventListener("click", doSurrender);
  newShoeBtn.addEventListener("click", ()=>{ if(!inRound){ freshShoe(); renderAll(); } });

  betInput.addEventListener("change", ()=>{
    bet = Math.max(1, Math.floor(Number(betInput.value)||10));
    betInput.value = bet;
    betDisp.textContent = bet;
  });

  moreBtn.addEventListener("click", e=>{
    e.stopPropagation();
    moreMenu.style.display = (moreMenu.style.display==="block" ? "none" : "block");
  });
  document.addEventListener("click", ()=>{
    moreMenu.style.display = "none";
  });

  // boot
  freshShoe();
  renderAll();
})();
</script>
<div id="backWrap" style="text-align:center; margin-top:20px;">
  <a href="index.html" id="backBtn" style="font-size:16px; color:black; text-decoration:none;">
    âŸµ Back
  </a>
</div>
</body>
</html>
</body>
</html>
