<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Blackjack — Retro Symmetrical Lamp</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --win:#c0c0c0; --light:#ffffff; --mid:#dfdfdf; --shadow:#808080; --dark:#000000;
    --felt:#5a7751; --ink:#000; --red:#b00000;
  }
  *{box-sizing:border-box; user-select:none}
  html,body{height:100%}
  body{
    margin:0; background:var(--win); color:var(--ink);
    font:14px/1 Tahoma, Verdana, Arial, sans-serif;
    display:flex; align-items:center; justify-content:center;
  }

  .window{
    background:var(--win); border:2px solid var(--dark);
    box-shadow: inset -1px -1px 0 var(--shadow), inset 1px 1px 0 var(--light),
                inset -2px -2px 0 var(--dark), inset 2px 2px 0 var(--mid);
    padding:8px; width:min(96vw, 960px);
  }
  .titlebar{
    background:linear-gradient(#000080,#0000a8); color:#fff;
    padding:3px 6px; margin-bottom:6px;
    display:flex; justify-content:space-between; align-items:center;
    font-weight:700;
  }
  .frame{
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    padding:8px; background:var(--mid);
  }

  .panel{
    display:flex; gap:8px; flex-wrap:wrap;
    align-items:center; justify-content:space-between;
    padding:6px; background:var(--mid);
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    margin-bottom:8px;
  }
  .badge{
    min-width:120px; text-align:center; font-weight:700;
    background:#6b0000; color:#ff1a1a;
    font-family:"Courier New", monospace; letter-spacing:1px;
    padding:4px 8px; border:2px solid var(--dark);
    box-shadow: inset 0 1px 0 #3d0000, inset 0 -1px 0 #3d0000,
                inset 1px 0 0 #3d0000, inset -1px 0 0 #3d0000;
  }
  .small{ font-size:12px; opacity:.85 }
  .label{font-weight:700; margin-right:4px}
  input[type=number]{
    width:90px; background:var(--win); border:2px solid var(--shadow); padding:2px 4px;
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    font:14px/1 Tahoma, Arial;
  }

  .table{ display:grid; grid-template-columns:1fr 230px; gap:8px }
  .felt{
    background:var(--felt); border-radius:8px; padding:12px;
    border:2px solid #2f3f2f;
    box-shadow: inset -1px -1px 0 #2f3f2f, inset 1px 1px 0 #000;
    min-height:420px;
  }

  .heading{
    font-weight:700; margin-bottom:4px;
    display:flex; align-items:center; gap:8px;
  }
  .tot{
    background:#000; color:#ff1a1a;
    font-family:"Courier New", monospace;
    padding:2px 6px; border:2px inset #333;
    min-width:24px; text-align:center;
  }

  .cards{ display:flex; gap:6px; flex-wrap:wrap }

  .hands{ display:flex; flex-direction:column; gap:8px; margin-top:4px }
  .hand{
    background:rgba(255,255,255,0.08);
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    padding:6px; border-radius:4px;
  }
  .hand.active{ outline:2px dotted #000 }

  .card{
    width:48px; height:64px;
    border:1px solid #999; border-radius:2px;
    background:#fff; display:grid; place-items:center;
    font-family:"Courier New", monospace; font-weight:700; color:#000;
  }
  .card.red{ color:var(--red); }
  .card.back{ background:#d9d9d9; border-style:double; }

  .card.fly{
    position:relative;
    animation:dealIn 260ms ease-out forwards;
  }
  @keyframes dealIn{
    from{ transform:translate(-60px,-50px) scale(.85); opacity:0; }
    to{ transform:translate(0,0) scale(1); opacity:1; }
  }

  .card.flip{
    animation:flipReveal 320ms ease-out forwards;
    transform-origin:center;
  }
  @keyframes flipReveal{
    0%{ transform:scaleX(0); }
    100%{ transform:scaleX(1); }
  }

  .side{ display:grid; gap:8px }
  .group{
    background:var(--mid);
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    padding:8px;
  }
  .group button{ margin:2px 2px }

  button{
    background:var(--win); border:2px solid var(--shadow); padding:6px 12px; cursor:pointer;
    box-shadow: inset -1px -1px 0 var(--dark), inset 1px 1px 0 var(--light);
    font:14px/1 Tahoma, Arial;
  }
  button:active{
    box-shadow: inset -1px -1px 0 var(--light), inset 1px 1px 0 var(--dark);
  }
  button:disabled{ color:#666; cursor:not-allowed }

  .morewrap{ position:relative; display:inline-block }
  .moremenu{
    position:absolute; right:0; top:110%; min-width:170px; display:none; z-index:10;
    background:var(--win); border:2px solid var(--dark);
    box-shadow:4px 4px 0 rgba(0,0,0,.25),
      inset -1px -1px 0 var(--shadow),
      inset 1px 1px 0 var(--light);
  }
  .moremenu button{
    width:100%; text-align:left; padding:6px 10px; border:none; border-bottom:1px solid #aaa;
  }
  .moremenu button:last-child{ border-bottom:none }

  .msg{ margin-top:10px; font-weight:700 }

  .backwrap{
    text-align:center; margin-top:14px;
  }
  .backbtn{
    font:14px Tahoma, Arial;
    padding:6px 22px;
    background:var(--win);
    border:2px solid var(--shadow);
    box-shadow: inset -1px -1px 0 var(--dark),
                inset 1px 1px 0 var(--light);
    cursor:pointer;
    text-decoration:none;
    color:black;
    display:inline-block;
  }
  .backbtn:active{
    box-shadow: inset -1px -1px 0 var(--light),
                inset 1px 1px 0 var(--dark);
  }

  @media (max-width:820px){
    .table{ grid-template-columns:1fr }
  }
</style>
</head>
<body>
<div class="window">
  <div class="titlebar">
    <div>Blackjack</div><div>Retro Style</div>
  </div>
  <div class="frame">
    <div class="panel">
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
        <div class="badge">BANK $<span id="bank">1000</span></div>
        <div class="badge">BET $<span id="betDisp">10</span></div>
        <div class="badge">SHOE <span id="shoeLeft">0</span></div>
      </div>
      <div style="display:flex; gap:6px; align-items:center">
        <span class="label">Bet</span>
        <input id="bet" type="number" min="1" step="1" value="10">
      </div>
    </div>

    <div class="table">
      <div class="felt">
        <div class="heading">
          DEALER <span class="tot" id="dealerTot"></span>
        </div>
        <div class="cards" id="dealerCards"></div>

        <hr style="border:0; height:2px; background:#2f3f2f; margin:10px 0">

        <div class="heading">
          PLAYER
        </div>
        <div id="hands" class="hands"></div>

        <div id="msg" class="msg"></div>
      </div>

      <div class="side">
        <div class="group">
          <button id="deal">Deal</button>
          <button id="hit" disabled>Hit</button>
          <button id="stand" disabled>Stand</button>
          <div class="morewrap">
            <button id="more">…</button>
            <div class="moremenu" id="moreMenu">
              <button id="double" disabled>Double</button>
              <button id="split" disabled>Split</button>
              <button id="surrender" disabled>Surrender</button>
            </div>
          </div>
        </div>
        <div class="group">
          <button id="newShoe">New 6-Deck Shoe</button>
          <div class="small" style="margin-top:6px">Blackjack pays 3:2 • Dealer stands on 17</div>
        </div>
      </div>
    </div>
  </div>

  <div class="backwrap">
    <a href="../index.html" class="backbtn">⟵ Back</a>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  const bankEl = $("bank"), betEl = $("bet"), betDisp = $("betDisp"), shoeLeft = $("shoeLeft");
  const dealerCardsEl = $("dealerCards"), dealerTotEl = $("dealerTot");
  const handsContainer = $("hands"), msgEl = $("msg");

  const dealBtn = $("deal"), hitBtn = $("hit"), standBtn = $("stand");
  const moreBtn = $("more"), moreMenu = $("moreMenu");
  const doubleBtn = $("double"), splitBtn = $("split"), surrenderBtn = $("surrender");
  const newShoeBtn = $("newShoe");

  const SUITS = ["♠","♥","♦","♣"];
  const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  const DECKS = 6, CUT = 0.75;

  let bankroll = 1000;
  let baseBet = 10;
  let roundStartBankroll = 1000;

  let shoe = [];
  let dealer = [];
  let hands = []; // {cards:[], bet, done, surrendered}
  let handViews = []; // {wrapper, cardsEl, totEl}

  let activeIndex = 0;
  let holeDown = true;
  let inRound = false;
  let firstAction = false;

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
  }

  function freshShoe(){
    shoe = [];
    for(let d=0; d<DECKS; d++){
      for(const s of SUITS){
        for(const r of RANKS){
          shoe.push({rank:r,suit:s});
        }
      }
    }
    shuffle(shoe);
    updateShoe();
    msg("New shoe ready.");
  }

  function updateShoe(){
    shoeLeft.textContent = shoe.length;
  }

  function draw(){
    if(!shoe.length) freshShoe();
    const c = shoe.pop();
    updateShoe();
    return c;
  }

  function ensurePenetration(){
    if(shoe.length < 52*DECKS*(1-CUT)){
      freshShoe();
    }
  }

  function val(rank){
    if(rank === "A") return 11;
    if(["10","J","Q","K"].includes(rank)) return 10;
    return parseInt(rank,10);
  }

  function totalHand(cards){
    let t=0, aces=0;
    for(const c of cards){
      t += val(c.rank);
      if(c.rank==="A") aces++;
    }
    while(t>21 && aces>0){
      t-=10; aces--;
    }
    return t;
  }

  function isRed(s){ return s==="♥" || s==="♦"; }

  function cardElement(card){
    const el = document.createElement("div");
    el.className = "card" + (isRed(card.suit) ? " red" : "");
    el.textContent = card.rank + card.suit;
    return el;
  }

  function backCard(){
    const el = document.createElement("div");
    el.className = "card back";
    return el;
  }

  async function dealToHand(handIdx, card, animate=true){
    const view = handViews[handIdx];
    const el = cardElement(card);
    if(animate){
      el.classList.add("fly");
    }
    view.cardsEl.appendChild(el);
    if(animate){
      await sleep(280);
      el.classList.remove("fly");
    }
  }

  async function dealToDealer(card, opts){
    const {faceDown=false, animate=true, flip=false} = opts || {};
    if(faceDown){
      dealerCardsEl.appendChild(backCard());
      if(animate) await sleep(200);
      return;
    }
    const el = cardElement(card);
    if(animate) el.classList.add("fly");
    dealerCardsEl.appendChild(el);
    if(animate) await sleep(260);
    if(flip){
      el.classList.remove("fly");
      el.classList.add("flip");
      await sleep(320);
      el.classList.remove("flip");
    }else{
      el.classList.remove("fly");
    }
  }

  function renderDealer(showHole){
    dealerCardsEl.innerHTML = "";
    dealer.forEach((c,i)=>{
      if(i===1 && holeDown && !showHole){
        dealerCardsEl.appendChild(backCard());
      }else{
        dealerCardsEl.appendChild(cardElement(c));
      }
    });
  }

  function updateTotals(showHole){
    // dealer
    if(!dealer.length){
      dealerTotEl.textContent = "";
    }else if(showHole || !holeDown){
      dealerTotEl.textContent = totalHand(dealer);
    }else{
      dealerTotEl.textContent = totalHand([dealer[0]]);
    }
    // hands
    hands.forEach((h,i)=>{
      const view = handViews[i];
      const t = h.cards.length ? totalHand(h.cards) : "";
      view.totEl.textContent = t;
      view.wrapper.classList.toggle("active", inRound && i===activeIndex);
    });
  }

  function buildHandsLayout(){
    handsContainer.innerHTML = "";
    handViews = [];
    hands.forEach((h,i)=>{
      const wrap = document.createElement("div");
      wrap.className = "hand";
      const heading = document.createElement("div");
      heading.className = "heading";
      const label = document.createElement("span");
      label.textContent = "Hand " + (i+1);
      const totSpan = document.createElement("span");
      totSpan.className = "tot";
      heading.appendChild(label);
      heading.appendChild(totSpan);
      const cardsDiv = document.createElement("div");
      cardsDiv.className = "cards";
      wrap.appendChild(heading);
      wrap.appendChild(cardsDiv);
      handsContainer.appendChild(wrap);
      handViews.push({wrapper:wrap, cardsEl:cardsDiv, totEl:totSpan});
    });
  }

  function msg(text){
    msgEl.textContent = text || "";
  }

  function updateButtons(){
    if(!inRound){
      dealBtn.disabled = false;
      hitBtn.disabled = true;
      standBtn.disabled = true;
      doubleBtn.disabled = true;
      splitBtn.disabled = true;
      surrenderBtn.disabled = true;
      return;
    }
    dealBtn.disabled = true;

    const h = hands[activeIndex];

    hitBtn.disabled = false;
    standBtn.disabled = false;

    const canDouble = firstAction && h.cards.length===2 && bankroll >= h.bet;
    const canSplit =
      firstAction &&
      hands.length === 1 &&
      h.cards.length===2 &&
      val(h.cards[0].rank) === val(h.cards[1].rank) &&
      bankroll >= h.bet;

    const canSurrender =
      firstAction &&
      hands.length === 1 &&
      h.cards.length===2;

    doubleBtn.disabled = !canDouble;
    splitBtn.disabled = !canSplit;
    surrenderBtn.disabled = !canSurrender;
  }

  function anyPlayableHands(){
    return hands.some(h => !h.surrendered && totalHand(h.cards) <= 21);
  }

  function nextHandIndex(from){
    for(let i=from+1;i<hands.length;i++){
      const h = hands[i];
      if(!h.surrendered && !h.done && totalHand(h.cards)<=21){
        return i;
      }
    }
    return -1;
  }

  async function startRound(){
    if(inRound) return;

    baseBet = Math.max(1, Math.floor(Number(betEl.value || 10)));
    betEl.value = baseBet;
    betDisp.textContent = baseBet;

    if(baseBet > bankroll){
      msg("Bet exceeds bankroll.");
      return;
    }

    ensurePenetration();

    roundStartBankroll = bankroll;
    bankroll -= baseBet;
    bankEl.textContent = bankroll;

    dealer = [];
    hands = [{cards:[], bet:baseBet, done:false, surrendered:false}];
    activeIndex = 0;
    holeDown = true;
    inRound = true;
    firstAction = true;
    msg("");

    buildHandsLayout();
    dealerCardsEl.innerHTML = "";
    updateTotals(false);
    updateButtons();

    // Initial 4-card deal with pacing: P, D, P, D(hole)
    const p1 = draw();
    const d1 = draw();
    const p2 = draw();
    const d2 = draw();

    hands[0].cards.push(p1);
    await dealToHand(0, p1, true);
    updateTotals(false);

    dealer.push(d1);
    await dealToDealer(d1, {faceDown:false, animate:true});
    updateTotals(false);

    hands[0].cards.push(p2);
    await dealToHand(0, p2, true);
    updateTotals(false);

    dealer.push(d2);
    await dealToDealer(d2, {faceDown:true, animate:true});
    updateTotals(false);

    const pTot = totalHand(hands[0].cards);
    const dTot = totalHand(dealer);
    const playerBJ = (pTot === 21);
    const dealerBJ = (dTot === 21);

    if(playerBJ || dealerBJ){
      await resolveNaturals(playerBJ, dealerBJ);
    }
  }

  async function resolveNaturals(playerBJ, dealerBJ){
    holeDown = false;
    renderDealer(true);
    updateTotals(true);

    let text = "";
    let net = 0;
    const b = hands[0].bet;

    if(playerBJ && dealerBJ){
      text = "Push (both blackjack).";
      bankroll += b;
    }else if(playerBJ){
      text = "Blackjack!";
      const pay = b * 2.5;
      bankroll += pay;
      net = pay - b;
    }else if(dealerBJ){
      text = "Dealer blackjack.";
    }

    bankEl.textContent = bankroll;
    inRound = false;
    updateButtons();
    msg(net>0 ? `${text} You win $${net}.` : text);
  }

  async function hit(){
    if(!inRound) return;
    const h = hands[activeIndex];
    const c = draw();
    h.cards.push(c);
    firstAction = false;

    await dealToHand(activeIndex, c, true);
    updateTotals(false);

    const t = totalHand(h.cards);
    if(t>21){
      h.done = true;
      const next = nextHandIndex(activeIndex);
      if(next !== -1){
        activeIndex = next;
        firstAction = true;
        updateTotals(false);
        updateButtons();
      }else{
        inRound = false;
        updateButtons();
        await finishRound(false);
      }
    }else{
      updateButtons();
    }
  }

  async function stand(){
    if(!inRound) return;
    const h = hands[activeIndex];
    h.done = true;
    firstAction = false;

    const next = nextHandIndex(activeIndex);
    if(next !== -1){
      activeIndex = next;
      firstAction = true;
      updateTotals(false);
      updateButtons();
      return;
    }

    const live = anyPlayableHands();
    if(live){
      await dealerPlay();
      await finishRound(true);
    }else{
      inRound = false;
      updateButtons();
      await finishRound(false);
    }
  }

  async function doubleDown(){
    if(!inRound) return;
    const h = hands[activeIndex];
    if(!(firstAction && h.cards.length===2 && bankroll >= h.bet)) return;

    bankroll -= h.bet;
    bankEl.textContent = bankroll;
    h.bet *= 2;

    const c = draw();
    h.cards.push(c);
    firstAction = false;

    await dealToHand(activeIndex, c, true);
    updateTotals(false);

    const t = totalHand(h.cards);
    h.done = true;

    const next = nextHandIndex(activeIndex);
    if(t>21){
      if(next !== -1){
        activeIndex = next;
        firstAction = true;
        updateTotals(false);
        updateButtons();
      }else{
        inRound = false;
        updateButtons();
        await finishRound(false);
      }
    }else{
      if(next !== -1){
        activeIndex = next;
        firstAction = true;
        updateTotals(false);
        updateButtons();
      }else{
        const live = anyPlayableHands();
        if(live){
          await dealerPlay();
          await finishRound(true);
        }else{
          inRound = false;
          updateButtons();
          await finishRound(false);
        }
      }
    }
  }

  async function splitHand(){
    if(!inRound) return;
    if(hands.length !== 1) return;
    const h = hands[0];
    if(!(firstAction && h.cards.length===2 && bankroll >= h.bet)) return;
    if(val(h.cards[0].rank) !== val(h.cards[1].rank)) return;

    bankroll -= h.bet;
    bankEl.textContent = bankroll;

    const c1 = h.cards[0];
    const c2 = h.cards[1];

    hands = [
      {cards:[c1], bet:h.bet, done:false, surrendered:false},
      {cards:[c2], bet:h.bet, done:false, surrendered:false}
    ];
    activeIndex = 0;
    firstAction = true;

    buildHandsLayout();

    handViews[0].cardsEl.appendChild(cardElement(c1));
    handViews[1].cardsEl.appendChild(cardElement(c2));
    updateTotals(false);

    // deal one extra card to each hand with animation
    for(let i=0;i<hands.length;i++){
      const c = draw();
      hands[i].cards.push(c);
      await dealToHand(i, c, true);
      updateTotals(false);
      await sleep(120);
    }

    activeIndex = 0;
    firstAction = true;
    updateTotals(false);
    updateButtons();
  }

  async function surrender(){
    if(!inRound) return;
    if(!firstAction) return;
    if(hands.length !== 1) return;
    const h = hands[0];
    if(h.cards.length !== 2) return;

    h.surrendered = true;
    h.done = true;
    inRound = false;

    const refund = Math.floor(h.bet / 2);
    bankroll += refund;
    bankEl.textContent = bankroll;

    updateTotals(false);
    updateButtons();
    msg(`Surrender. You lose $${h.bet - refund}.`);
  }

  async function dealerPlay(){
    holeDown = false;
    renderDealer(true);
    updateTotals(true);
    await sleep(300);

    while(totalHand(dealer) < 17){
      const c = draw();
      dealer.push(c);
      await dealToDealer(c, {faceDown:false, animate:true});
      updateTotals(true);
      await sleep(220);
    }
  }

  async function finishRound(dealerPlayed){
    const dTot = dealerPlayed ? totalHand(dealer) : totalHand(dealer);
    // settle payouts
    for(const h of hands){
      if(h.surrendered) continue;
      const pTot = totalHand(h.cards);
      if(pTot>21){
        // lose, nothing added
      }else if(dTot>21){
        bankroll += h.bet * 2;
      }else if(pTot > dTot){
        bankroll += h.bet * 2;
      }else if(pTot < dTot){
        // lose
      }else{
        bankroll += h.bet;
      }
    }
    bankEl.textContent = bankroll;
    const net = bankroll - roundStartBankroll;
    if(net > 0){
      msg(`You won $${net}.`);
    }else if(net < 0){
      msg(`You lost $${-net}.`);
    }else{
      msg("Push / break even.");
    }
  }

  // Wire up
  dealBtn.onclick = startRound;
  hitBtn.onclick = hit;
  standBtn.onclick = stand;
  doubleBtn.onclick = doubleDown;
  splitBtn.onclick = splitHand;
  surrenderBtn.onclick = surrender;

  moreBtn.onclick = e=>{
    e.stopPropagation();
    moreMenu.style.display = (moreMenu.style.display==="block" ? "none" : "block");
  };
  document.addEventListener("click", ()=>{ moreMenu.style.display="none"; });

  newShoeBtn.onclick = ()=>{
    if(!inRound){
      freshShoe();
      dealer = [];
      hands = [];
      buildHandsLayout();
      dealerCardsEl.innerHTML = "";
      updateTotals(false);
      msg("");
    }
  };

  betEl.onchange = ()=>{
    baseBet = Math.max(1, Math.floor(Number(betEl.value)||10));
    betEl.value = baseBet;
    betDisp.textContent = baseBet;
  };

  // boot
  freshShoe();
  hands = [];
  buildHandsLayout();
  updateTotals(false);
  msg("");
  updateButtons();
})();
</script>
</body>
</html>
